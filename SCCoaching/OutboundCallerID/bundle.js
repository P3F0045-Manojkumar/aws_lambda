(()=>{"use strict";let e;function t(t){if(!e)throw new Error(null!=t?t:"Attempted to get Global AmazonConnectProvider that has not been set.");return e}class s{constructor({config:e,proxyFactory:t}){if(!t)throw new Error("Attempted to get Proxy before setting up factory");if(!e)throw new Error("Failed to include config");this.proxyFactory=t,this._config=e}getProxy(){return this.proxy||(this.proxy=this.proxyFactory(this),this.proxy.init()),this.proxy}get config(){return Object.assign({},this._config)}onError(e){this.getProxy().onError(e)}offError(e){this.getProxy().offError(e)}static initializeProvider(t){const s=new a({source:"core.amazonConnect.init",provider:t});if(this.isInitialized){const e="Error: Attempted to initialize provider more than one time.";throw s.error(e),new Error(e)}return function(t){if(e)throw new Error("Global Provider is already set");e=t}(t),this.isInitialized=!0,t.getProxy(),t}}function n(){return"randomUUID"in crypto?crypto.randomUUID():"10000000-1000-4000-8000-100000000000".replace(/[018]/g,(e=>{const t=parseInt(e);return(t^crypto.getRandomValues(new Uint8Array(1))[0]&15>>t/4).toString(16)}))}s.isInitialized=!1;class r{constructor(e,t){this.timeoutMs=t,this.onCancelled=e,this.timeout=setTimeout((()=>this.handleCancel()),this.timeoutMs),this.status="running",this.logger=new a({source:"core.utility.timeout-tracker",mixin:()=>({timeoutMs:this.timeoutMs,timeoutTrackerStatus:this.status})})}static start(e,t){return new r(e,t)}complete(){switch(this.status){case"running":return this.handleComplete();case"completed":return this.logger.debug("TimeoutTracker already marked complete. No action."),!0;case"cancelled":return this.logger.info("Attempted to complete a TimeoutTracker that has already been cancelled"),!1}}isCancelled(){return"cancelled"===this.status}getStatus(){return this.status}handleCancel(){switch(this.status){case"running":this.status="cancelled",this.logger.info("TimeoutTracker has timed out. Invoking onCancelled Handler"),this.invokeOnCancelled();break;case"completed":this.logger.debug("Cancel operation for TimerTracker invoked after already completed. No action.");break;default:throw new Error("Cancel operation in TimerTracker called during an unexpected time.")}}handleComplete(){return this.status="completed",clearTimeout(this.timeout),!0}invokeOnCancelled(){try{this.onCancelled({timeoutMs:this.timeoutMs})}catch(e){this.logger.error("Error when attempting to invoke TimeoutTrackerCancelledHandler",{error:e})}}}var i;!function(e){e[e.trace=1]="trace",e[e.debug=2]="debug",e[e.info=3]="info",e[e.warn=4]="warn",e[e.error=5]="error"}(i||(i={}));class o{constructor(e){this.mixin=e}getTransformedData(e,t){return this.mixin?Object.assign(Object.assign({},null!=t?t:{}),this.mixin(null!=t?t:{},e)):t}}class a{constructor(e){this._proxy=null,this._logToConsoleLevel=null,this.loggerId=function(){const e=new Uint8Array(Math.ceil(4));return crypto.getRandomValues(e),Array.from(e,(e=>e.toString(16).padStart(2,"0"))).join("").substring(0,8)}(),"string"==typeof e?(this.source=e,this.dataTransformer=new o(void 0)):(this.source=e.source,e.provider&&"function"==typeof e.provider?this.providerFactory=e.provider:this.provider=e.provider,this.dataTransformer=new o(e.mixin),this.logOptions=e.options)}trace(e,t,s){this.log(i.trace,e,t,s)}debug(e,t,s){this.log(i.debug,e,t,s)}info(e,t,s){this.log(i.info,e,t,s)}warn(e,t,s){this.log(i.warn,e,t,s)}error(e,t,s){this.log(i.error,e,t,s)}log(e,t,s,n){const r=this.dataTransformer.getTransformedData(e,s);this.ignoreRemote(n)||this.getProxy().log({level:e,source:this.source,loggerId:this.loggerId,message:t,data:r}),this.applyDuplicateMessageToConsole(e,n)&&function(e,t,s){if(s)switch(e){case i.error:console.error(t,s);break;case i.warn:console.warn(t,s);break;case i.info:console.info(t,s);break;case i.debug:console.debug(t,s);break;case i.trace:console.trace(t,s);break;default:console.log(t,s)}else switch(e){case i.error:console.error(t);break;case i.warn:console.warn(t);break;case i.info:console.info(t);break;case i.debug:console.debug(t);break;case i.trace:console.trace(t);break;default:console.log(t)}}(e,t,r)}getProvider(){return this.provider||(this.provider=this.providerFactory?this.providerFactory():t()),this.provider}getProxy(){return this._proxy||(this._proxy=this.getProvider().getProxy()),this._proxy}applyDuplicateMessageToConsole(e,t){return(null==t?void 0:t.duplicateMessageToConsole)||this.getLogConsoleLevel()<=e}getLogConsoleLevel(){var e,t,s,n;return this._logToConsoleLevel||(this._logToConsoleLevel=(null===(e=this.logOptions)||void 0===e?void 0:e.minLogToConsoleLevelOverride)?this.logOptions.minLogToConsoleLevelOverride:null!==(n=null===(s=null===(t=this.getProvider().config)||void 0===t?void 0:t.logging)||void 0===s?void 0:s.minLogToConsoleLevel)&&void 0!==n?n:i.error),this._logToConsoleLevel}ignoreRemote(e){var t,s,n;return null!==(s=null===(t=this.logOptions)||void 0===t?void 0:t.remoteIgnore)&&void 0!==s&&s||null!==(n=null==e?void 0:e.remoteIgnore)&&void 0!==n&&n}}class c{constructor(){this.idsByHandler=new Map,this.handlersById=new Map}add(e){const t=this.idsByHandler.get(e);if(t)return{handlerId:t};const s=n();return this.idsByHandler.set(e,s),this.handlersById.set(s,e),{handlerId:s}}getIdByHandler(e){var t;return null!==(t=this.idsByHandler.get(e))&&void 0!==t?t:null}getHandlerById(e){var t;return null!==(t=this.handlersById.get(e))&&void 0!==t?t:null}get(){return[...this.idsByHandler.entries()].map((([e,t])=>({handler:e,handlerId:t})))}delete(e){const t=this.idsByHandler.get(e);return t&&this.handlersById.delete(t),this.idsByHandler.delete(e),{isEmpty:this.idsByHandler.size<1}}size(){return this.idsByHandler.size}}class l{constructor(){this.simpleSubscriptions=new Map,this.paramSubscriptions=new Map}add({namespace:e,key:t,parameter:s},n){var r,i,o,a,c;if(s){if(!this.paramSubscriptions.has(e))return void this.paramSubscriptions.set(e,new Map([[t,new Map([[s,n]])]]));if(!(null===(r=this.paramSubscriptions.get(e))||void 0===r?void 0:r.has(t)))return void(null===(i=this.paramSubscriptions.get(e))||void 0===i||i.set(t,new Map([[s,n]])));null===(a=null===(o=this.paramSubscriptions.get(e))||void 0===o?void 0:o.get(t))||void 0===a||a.set(s,n)}else{if(!this.simpleSubscriptions.has(e))return void this.simpleSubscriptions.set(e,new Map([[t,n]]));null===(c=this.simpleSubscriptions.get(e))||void 0===c||c.set(t,n)}}delete({namespace:e,key:t,parameter:s}){var n,r,i,o;s?(null===(r=null===(n=this.paramSubscriptions.get(e))||void 0===n?void 0:n.get(t))||void 0===r?void 0:r.delete(s))&&this.paramSubscriptions.get(e).get(t).size<1&&(null===(i=this.paramSubscriptions.get(e))||void 0===i||i.delete(t),this.paramSubscriptions.get(e).size<1&&this.paramSubscriptions.delete(e)):(null===(o=this.simpleSubscriptions.get(e))||void 0===o?void 0:o.delete(t))&&this.simpleSubscriptions.get(e).size<1&&this.simpleSubscriptions.delete(e)}get({namespace:e,key:t,parameter:s}){var n,r,i;return s?null===(i=null===(r=this.paramSubscriptions.get(e))||void 0===r?void 0:r.get(t))||void 0===i?void 0:i.get(s):null===(n=this.simpleSubscriptions.get(e))||void 0===n?void 0:n.get(t)}getOrAdd(e,t){let s=this.get(e);return s||(s=t(),this.add(e,s)),s}addOrUpdate(e,t,s){let n=this.get(e);return n=n?s(n):t(),this.add(e,n),n}getAllSubscriptions(){return[...Array.from(this.simpleSubscriptions.keys()).flatMap((e=>Array.from(this.simpleSubscriptions.get(e).keys()).flatMap((t=>({namespace:e,key:t}))))),...Array.from(this.paramSubscriptions.keys()).flatMap((e=>Array.from(this.paramSubscriptions.get(e).keys()).flatMap((t=>Array.from(this.paramSubscriptions.get(e).get(t).keys()).flatMap((s=>({namespace:e,key:t,parameter:s})))))))]}}class d{constructor(){this.subscriptions=new l}add(e,t){return this.subscriptions.getOrAdd(e,(()=>new c)).add(t)}get(e){var t,s;return null!==(s=null===(t=this.subscriptions.get(e))||void 0===t?void 0:t.get())&&void 0!==s?s:[]}getById(e,t){var s,n;return null!==(n=null===(s=this.subscriptions.get(e))||void 0===s?void 0:s.getHandlerById(t))&&void 0!==n?n:null}delete(e,t){var s,n;null!==(n=null===(s=this.subscriptions.get(e))||void 0===s?void 0:s.delete(t).isEmpty)&&void 0!==n&&n&&this.subscriptions.delete(e)}size(e){var t,s;return null!==(s=null===(t=this.subscriptions.get(e))||void 0===t?void 0:t.size())&&void 0!==s?s:0}isEmpty(e){return 0===this.size(e)}getAllSubscriptions(){return this.subscriptions.getAllSubscriptions()}}class u{constructor(){this.requestMap=new Map,this.logger=new a({source:"core.requestManager"})}processRequest(e){const{requestId:t}=e;return function(e,t,s,n){const r=Math.max(1,null!=n?n:3e4);return new Promise(((n,i)=>{let o=!1;const a=setTimeout((()=>{s({timeoutMs:r,request:e}),i(function(e,t){const{namespace:s,command:n,data:r}=e;return{namespace:s,reason:"Client Timeout",details:{command:n,requestData:r,timeoutMs:t},errorKey:"clientTimeout"}}(e,r)),o=!0}),r);t((e=>{var t;clearTimeout(a),o||(e.isError?i({namespace:(t=e).namespace,reason:t.reason,details:t.details,errorKey:t.errorKey}):n(e.data))}))}))}(e,(e=>this.requestMap.set(t,e)),(({request:e,timeoutMs:t})=>this.handleTimeout(e,t)))}processResponse(e){const{requestId:t}=e,s=this.requestMap.get(t);s?(s(e),this.requestMap.delete(t)):this.logger.error("Returned a response message with no handler",{message:e})}handleTimeout(e,t){const{requestId:s,namespace:n,command:r}=e;this.requestMap.delete(s),this.logger.error("Client request timeout",{requestId:s,namespace:n,command:r,timeoutMs:t})}}class g{constructor(){this.errorHandlers=new Set,this.logger=new a({source:"core.proxy.error"})}invoke(e){const{message:t,key:s,details:n,isFatal:r,connectionStatus:i}=e;this.logger.error(t,{key:s,details:n,isFatal:r,connectionStatus:i},{duplicateMessageToConsole:!0,remoteIgnore:!0}),[...this.errorHandlers].forEach((t=>{try{t(e)}catch(t){this.logger.error("An error occurred within a AmazonConnectErrorHandler",{handlerError:t,originalError:e})}}))}onError(e){this.errorHandlers.add(e)}offError(e){this.errorHandlers.delete(e)}}class h{constructor(){this.status="notConnected",this.changeHandlers=new Set,this.logger=new a({source:"core.proxy.connection-status-manager",mixin:()=>({status:this.status})})}getStatus(){return this.status}update(e){this.status=e.status,this.logger.trace("Proxy Connection Status Changed",{status:e.status}),[...this.changeHandlers].forEach((t=>{try{t(e)}catch(e){this.logger.error("An error occurred within a ProxyConnectionChangedHandler",{error:e})}}))}onChange(e){this.changeHandlers.add(e)}offChange(e){this.changeHandlers.delete(e)}}class p{constructor(e){this.provider=e,this.logger=new a({source:"core.proxy",mixin:()=>({proxyType:this.proxyType})}),this.requestManager=new u,this.status=new h,this.errorService=new g,this.upstreamMessageQueue=[],this.connectionEstablished=!1,this.isInitialized=!1,this.subscriptions=new d}init(){if(this.isInitialized)throw new Error("Proxy already initialized");this.isInitialized=!0,this.initProxy()}request(e,t,s,r){const i=function(e,t,s,r){return{type:"request",namespace:e,command:t,requestId:n(),data:s,messageOrigin:r}}(e,t,s,null!=r?r:this.getUpstreamMessageOrigin()),o=this.requestManager.processRequest(i);return this.sendOrQueueMessageToSubject(i),o}subscribe(e,t,s){const{handlerId:n}=this.subscriptions.add(e,t),r={type:"subscribe",topic:e,messageOrigin:null!=s?s:this.getUpstreamMessageOrigin(),handlerId:n};this.sendOrQueueMessageToSubject(r)}unsubscribe(e,t,s){if(this.subscriptions.delete(e,t),this.subscriptions.isEmpty(e)){const t={type:"unsubscribe",topic:e,messageOrigin:null!=s?s:this.getUpstreamMessageOrigin()};this.sendOrQueueMessageToSubject(t)}}log(e){const t=function({level:e,source:t,message:s,loggerId:n,data:r},i,o){const a=r?JSON.parse(JSON.stringify(r)):void 0;return{type:"log",level:e,time:new Date,source:t,message:s,loggerId:n,data:a,context:i,messageOrigin:o}}(e,this.addContextToLogger(),this.getUpstreamMessageOrigin());this.sendOrQueueMessageToSubject(t)}sendLogMessage(e){"log"===e.type?(e.context=Object.assign(Object.assign({},e.context),this.addContextToLogger()),this.sendOrQueueMessageToSubject(e)):this.logger.error("Attempted to send invalid log message",{message:e})}sendOrQueueMessageToSubject(e){this.connectionEstablished?this.sendMessageToSubject(e):this.upstreamMessageQueue.push(e)}consumerMessageHandler(e){if(!this.isInitialized)return void this.logger.error("Attempted to process message from subject prior to proxy being initializing. Message not processed",{originalMessageEventData:e.data});const{data:t}=e;if(!("type"in t))return void this.logger.warn("Unknown inbound message",{originalMessageEventData:t});const s=t;this.handleMessageFromSubject(s)}handleMessageFromSubject(e){this.handleDefaultMessageFromSubject(e)}handleDefaultMessageFromSubject(e){switch(e.type){case"acknowledge":this.handleConnectionAcknowledge();break;case"response":this.handleResponse(e);break;case"publish":this.handlePublish(e);break;case"error":this.handleError(e);break;default:return void this.logger.error("Unknown inbound message",{originalMessageEventData:e})}}handleConnectionAcknowledge(){for(this.status.update({status:"ready"}),this.connectionEstablished=!0;this.upstreamMessageQueue.length;){const e=this.upstreamMessageQueue.shift();this.sendMessageToSubject(e)}}handleResponse(e){this.requestManager.processResponse(e)}handlePublish(e){const{handlerId:t,topic:s}=e;if(t){const n=this.subscriptions.getById(s,t);n&&this.handleAsyncSubscriptionHandlerInvoke({handler:n,handlerId:t},e)}else this.subscriptions.get(s).map((t=>this.handleAsyncSubscriptionHandlerInvoke(t,e)))}handleError(e){if(e.isFatal){const{message:t,type:s}=e,n=function(e,t){var s={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(s[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(n=Object.getOwnPropertySymbols(e);r<n.length;r++)t.indexOf(n[r])<0&&Object.prototype.propertyIsEnumerable.call(e,n[r])&&(s[n[r]]=e[n[r]])}return s}(e,["message","type"]);this.status.update({status:"error",reason:t,details:n})}this.publishError({message:e.message,key:e.key,details:e.details,isFatal:e.isFatal,proxyStatus:e.status})}publishError(e){const t=Object.assign(Object.assign({},e),{connectionStatus:this.connectionStatus});this.errorService.invoke(t)}handleAsyncSubscriptionHandlerInvoke({handler:e,handlerId:t},{topic:s,data:n}){return r=this,i=void 0,a=function*(){try{yield e(n)}catch(e){this.logger.error("An error occurred when handling subscription",{topic:s,error:e,handlerId:t})}},new((o=void 0)||(o=Promise))((function(e,t){function s(e){try{c(a.next(e))}catch(e){t(e)}}function n(e){try{c(a.throw(e))}catch(e){t(e)}}function c(t){var r;t.done?e(t.value):(r=t.value,r instanceof o?r:new o((function(e){e(r)}))).then(s,n)}c((a=a.apply(r,i||[])).next())}));var r,i,o,a}get connectionStatus(){return this.status.getStatus()}onError(e){this.errorService.onError(e)}offError(e){this.errorService.offError(e)}onConnectionStatusChange(e){this.status.onChange(e)}offConnectionStatusChange(e){this.status.offChange(e)}}class y{constructor(e,t){this.engineContext=e,this.moduleNamespace=t}get proxy(){if(!this.moduleProxy){const e=this.engineContext.getProxy(),t=this.moduleNamespace;this.moduleProxy=function(e,t){return{request:(s,n)=>e.request(t,s,n),subscribe:(s,n)=>e.subscribe(Object.assign(Object.assign({},s),{namespace:t}),n),unsubscribe:(s,n)=>e.unsubscribe(Object.assign(Object.assign({},s),{namespace:t}),n),getProxyInfo:()=>({connectionStatus:e.connectionStatus,proxyType:e.proxyType}),onConnectionStatusChange:t=>e.onConnectionStatusChange(t),offConnectionStatusChange:t=>e.offConnectionStatusChange(t)}}(e,t)}return this.moduleProxy}createLogger(e){return this.engineContext.createLogger(e)}}class m{constructor(e){this.provider=e}getProxy(){return this.getProvider().getProxy()}getModuleContext(e){return new y(this,e)}getProvider(){return this.provider?this.provider:t()}createLogger(e){return new a("object"==typeof e?Object.assign(Object.assign({},e),{provider:()=>this.getProvider()}):{source:e,provider:()=>this.getProvider()})}}class f{constructor(e,t){var s;this.namespace=e,this.context=null!==(s=null==t?void 0:t.context)&&void 0!==s?s:new m(null==t?void 0:t.provider).getModuleContext(e)}}class v extends m{constructor(e,t,s,n){super(e),this.appInstanceId=t,this.appConfig=s,this.contactScope=n}}var b,C=function(e,t,s,n){return new(s||(s=Promise))((function(r,i){function o(e){try{c(n.next(e))}catch(e){i(e)}}function a(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,a)}c((n=n.apply(e,t||[])).next())}))};class x{constructor(e){this.provider=e,this.startHandlers=new Set,this.stopHandlers=new Set,this.state={isRunning:!1},this.isCreated=!1,this.isDestroyed=!1,this.logger=new a({source:"app.lifecycleManager",provider:e,mixin:()=>({state:this.state,isCreated:this.isCreated,isDestroyed:this.isDestroyed})})}handleLifecycleChangeMessage(e){const t=new v(this.provider,e.appInstanceId,e.appConfig,e.contactScope);this.state.appInstanceId=e.appInstanceId,this.state.appConfig=e.appConfig,this.state.contactScope=e.contactScope;const s={context:t};switch(e.stage){case"create":return this.handleCreate(s);case"start":return this.handleStart(s);case"stop":return this.handleStop(s);case"destroy":return this.handleDestroy(s)}}onStart(e,t){this.startHandlers.add(e),(null==t?void 0:t.invokeIfRunning)&&this.state.isRunning&&this.handleLifecycleChange(Object.assign(Object.assign({},this.getLifecycleChangeParams()),{stage:"start"}),(t=>e(t)),!1)}onStop(e){this.stopHandlers.add(e)}offStart(e){this.startHandlers.delete(e)}offStop(e){this.stopHandlers.delete(e)}get appState(){return Object.assign({},this.state)}handleCreate(e){var t;return C(this,void 0,void 0,(function*(){if(this.isDestroyed)return void this.logger.error("An attempt was Create after a Destroy. No Action",{appInstanceId:e.context.appInstanceId});if(this.isCreated)return void this.logger.error("An attempt was invoke Create after it was already invoked. No Action",{appInstanceId:e.context.appInstanceId});if(this.logger.debug("Begin Lifecycle Create",{appInstanceId:e.context.appInstanceId}),!(null===(t=this.provider.config)||void 0===t?void 0:t.onCreate)){const t="App did not specify an onCreated handler. This is required. Closing app",s={appInstanceId:e.context.appInstanceId};return this.logger.error(t,{appInstanceId:e.context.appInstanceId}),void this.provider.sendFatalError(t,s)}const{success:s}=yield this.handleLifecycleChange(Object.assign(Object.assign({},e),{stage:"create"}),(e=>this.provider.config.onCreate(e)),!0);s&&(this.isCreated=!0,this.sendLifecycleHandlerCompletedMessage(e.context.appInstanceId,"create"))}))}handleStart(e){return C(this,void 0,void 0,(function*(){if(this.isDestroyed)return void this.logger.error("An attempt was Start after a Destroy. No Action",{appInstanceId:e.context.appInstanceId});if(!this.isCreated)return void this.logger.error("An attempt was invoke Start before Create. No Action",{appInstanceId:e.context.appInstanceId});this.state.isRunning=!0,this.logger.info("Begin Lifecycle Start");const t=yield Promise.all([...this.startHandlers].map((t=>this.handleLifecycleChange(Object.assign(Object.assign({},e),{stage:"start"}),(e=>t(e)),!1))));this.logger.debug("Completed all start handlers",{count:this.startHandlers.size,errorCount:t.filter((({success:e})=>!e)).length})}))}handleStop(e){return C(this,void 0,void 0,(function*(){if(this.isDestroyed)return void this.logger.error("An attempt was Stop after a Destroy. No Action",{appInstanceId:e.context.appInstanceId});if(!this.isCreated)return void this.logger.error("An attempt was invoke Stop before Create. No Action",{appInstanceId:e.context.appInstanceId});this.state.isRunning=!1,this.logger.info("Begin Lifecycle Stop");const t=yield Promise.all([...this.stopHandlers].map((t=>this.handleLifecycleChange(Object.assign(Object.assign({},e),{stage:"stop"}),(e=>t(e)),!1))));this.logger.debug("Completed all stop handlers",{count:this.stopHandlers.size,errorCount:t.filter((({success:e})=>!e)).length})}))}handleDestroy(e){return C(this,void 0,void 0,(function*(){if(this.isDestroyed)return void this.logger.error("An attempt was invoke Destroy multiple times. No Action",{appInstanceId:e.context.appInstanceId});if(!this.isCreated)return void this.logger.error("An attempt was invoke Destroy before Create. No Action",{appInstanceId:e.context.appInstanceId});this.isDestroyed=!0,this.state.isRunning=!1,this.logger.info("Begin Lifecycle Destroy");const{config:t}=this.provider,{success:s}=yield this.handleLifecycleChange(Object.assign(Object.assign({},e),{stage:"destroy"}),(e=>t.onDestroy?t.onDestroy(e):Promise.resolve()),!0);s&&this.sendLifecycleHandlerCompletedMessage(e.context.appInstanceId,"destroy")}))}handleLifecycleChange(e,t,s){return C(this,void 0,void 0,(function*(){let n=!1;try{yield t(e),n=!0}catch(t){const{appInstanceId:n}=e.context;if(s){const s=`An fatal error occurred when handling a ${e.stage} lifecycle action. Closing app`;this.logger.error(s,{appInstanceId:n,error:t}),this.provider.sendFatalError(s,t)}else this.logger.error(`An error occurred when handling a ${e.stage} lifecycle action.`,{appInstanceId:n,error:t})}return{success:n}}))}getLifecycleChangeParams(){return{context:new v(this.provider,this.state.appInstanceId,this.state.appConfig,this.state.contactScope)}}sendLifecycleHandlerCompletedMessage(e,t){this.logger.debug(`Sending lifecycle ${t} completed signal`),this.provider.getProxy().sendLifecycleHandlerCompleted(e,t)}}class S extends p{constructor(e,t){super(e),this.channel=new MessageChannel,this.lifecycleManager=t,this.appLogger=new a({source:"app.appProxy",provider:e})}get proxyType(){return"AppProxy"}sendLifecycleHandlerCompleted(e,t){const s={type:"appLifecycleHandlerCompleted",stage:t,appInstanceId:e};this.sendOrQueueMessageToSubject(s)}tryCloseApp(e,t,s){const n={type:"closeApp",isFatalError:null!=t&&t,message:e,data:s};this.sendOrQueueMessageToSubject(n)}publish(e,t){const s={type:"appPublish",topic:e,data:t};this.sendOrQueueMessageToSubject(s)}initProxy(){var e,t,s;this.status.update({status:"initializing"}),this.channel.port1.onmessage=e=>this.consumerMessageHandler(e),this.connectionTimer=r.start(this.connectionTimeout.bind(this),(e=this.provider.config,Math.max(1,Math.min(6e4,null!==(s=null===(t=e.workspace)||void 0===t?void 0:t.connectionTimeout)&&void 0!==s?s:5e3)))),window.parent.postMessage({type:"connect-app-host-init",sdkVersion:"1.0.3"},"*",[this.channel.port2]),this.appLogger.debug("Send connect message to configure proxy")}sendMessageToSubject(e){this.channel.port1.postMessage(e)}getUpstreamMessageOrigin(){if(null===document||void 0===document?void 0:document.location){const{origin:e,pathname:t}=document.location;return{_type:"app",origin:e,path:t}}return{_type:"app",origin:"unknown",path:"unknown"}}handleConnectionAcknowledge(){this.connectionTimer.complete()?super.handleConnectionAcknowledge():this.appLogger.error("Workspace connection acknowledge received after timeout. App is not connected to workspace.",{timeout:this.connectionTimer.timeoutMs})}handleMessageFromSubject(e){"appLifecycle"===e.type?this.lifecycleManager.handleLifecycleChangeMessage(e).catch((e=>{this.appLogger.error("An error occurred when invoking handleLifecycleChangeMessage",{error:e})})):super.handleMessageFromSubject(e)}connectionTimeout(e){this.status.update({status:"error",reason:"Workspace connection timeout",details:Object.assign({},e)}),this.publishError({message:"App failed to connect to workspace in the allotted time",key:"workspaceConnectTimeout",details:Object.assign({},e),isFatal:!0,proxyStatus:{initialized:!1}})}addContextToLogger(){const{isRunning:e}=this.lifecycleManager.appState;if(null===document||void 0===document?void 0:document.location){const{origin:t,pathname:s}=document.location;return{appIsRunning:e,app:{origin:t,path:s}}}return{appIsRunning:e,app:{origin:"unknown",path:"unknown"}}}}class w extends s{constructor(e){super({config:e,proxyFactory:()=>this.createProxy()}),this.lifecycleManager=new x(this),this.logger=new a({provider:this,source:"app.provider"})}static init(e){const t=new w(e);return w.initializeProvider(t),{provider:t}}static get default(){return t("AmazonConnectApp has not been initialized")}createProxy(){return new S(this,this.lifecycleManager)}onStart(e,t){this.lifecycleManager.onStart(e,t)}onStop(e){this.lifecycleManager.onStop(e)}offStart(e){this.lifecycleManager.offStart(e)}offStop(e){this.lifecycleManager.offStop(e)}sendCloseAppRequest(e){this.getProxy().tryCloseApp(e,!1)}sendError(e,t){this.logger.error(e,t)}sendFatalError(e,t){this.getProxy().tryCloseApp(e,!0,t)}subscribe(e,t){this.getProxy().subscribe(e,t)}unsubscribe(e,t){this.getProxy().unsubscribe(e,t)}publish(e,t){this.getProxy().publish(e,t)}}!function(e){e.CurrentContactId="CURRENT_CONTACT"}(b||(b={}));var I,M,k,A;!function(e){e.getARN="agent/getARN",e.getName="agent/getName",e.getState="agent/getState",e.getRoutingProfile="agent/getRoutingProfile",e.getChannelConcurrency="agent/getChannelConcurrency",e.getExtension="agent/getExtension",e.getDialableCountries="agent/getDialableCountries"}(I||(I={})),function(e){e.getAttributes="contact/getAttributes",e.getInitialContactId="contact/getInitialContactId",e.getType="contact/getType",e.getStateDuration="contact/getStateDuration",e.getQueue="contact/getQueue",e.getQueueTimestamp="contact/getQueueTimestamp",e.getDescription="contact/getDescription",e.getReferences="contact/getReferences"}(M||(M={})),function(e){e.StartingACW="contact/acw",e.Connected="contact/connected",e.Connecting="contact/connecting",e.Destroyed="contact/destroy",e.Error="contact/error",e.Incoming="contact/incoming",e.Missed="contact/missed",e.Pending="contact/pending"}(k||(k={})),function(e){e.StateChanged="agent/stateChange"}(A||(A={}));var T=function(e,t,s,n){return new(s||(s=Promise))((function(r,i){function o(e){try{c(n.next(e))}catch(e){i(e)}}function a(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,a)}c((n=n.apply(e,t||[])).next())}))};class O extends f{constructor(e){super("aws.connect.contact",e)}getARN(){return T(this,void 0,void 0,(function*(){const{ARN:e}=yield this.context.proxy.request(I.getARN);return e}))}getName(){return T(this,void 0,void 0,(function*(){const{name:e}=yield this.context.proxy.request(I.getName);return e}))}getState(){return this.context.proxy.request(I.getState)}getRoutingProfile(){return this.context.proxy.request(I.getRoutingProfile)}getChannelConcurrency(){return this.context.proxy.request(I.getChannelConcurrency)}getExtension(){return T(this,void 0,void 0,(function*(){const{extension:e}=yield this.context.proxy.request(I.getExtension);return e}))}getDialableCountries(){return T(this,void 0,void 0,(function*(){const{dialableCountries:e}=yield this.context.proxy.request(I.getDialableCountries);return e}))}onStateChanged(e){this.context.proxy.subscribe({key:A.StateChanged},e)}offStateChanged(e){this.context.proxy.unsubscribe({key:A.StateChanged},e)}}const{provider:P}=w.init({onCreate:async e=>{console.log("Event:",e);const{appInstanceId:t}=e.context;console.log("App initialized: ",t),E()},onDestroy:e=>{console.log("App being destroyed",e)}}),E=async()=>{try{const e=new O,t=await e.getARN();console.log("Agent details:",t),window.agentDetails=t}catch(e){console.error("Failed to fetch agent details:",e)}}})();